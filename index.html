<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOP - Global Ranking</title>
    <meta name="description" content="TOP - A Neon Stack Rhythm Game with Global Leaderboard">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-wrapper {
            position: relative;
            background-color: #050505;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        canvas {
            display: block;
            outline: none;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #score-container {
            position: absolute;
            top: 15%;
            text-align: center;
        }

        #score {
            font-size: 6rem;
            font-weight: 900;
            margin: 0;
            line-height: 1;
            background: linear-gradient(to bottom, #FFFF00, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
            transition: transform 0.1s;
        }
        
        .score-pop {
            animation: scorePopAnim 0.3s ease-out forwards;
        }

        @keyframes scorePopAnim {
            0% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)); }
            50% { transform: scale(1.4); filter: drop-shadow(0 0 50px rgba(255, 255, 255, 1)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)); }
        }

        #combo-msg {
            position: absolute;
            top: 28%;
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            opacity: 0;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
        }

        #intro-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            padding-top: 120px; 
            box-sizing: border-box;
            z-index: 20;
            pointer-events: auto;
            cursor: pointer;
            transition: opacity 0.5s;
        }
        #intro-screen h1 {
            font-size: 5rem; 
            color: #fff; 
            margin: 0;
            text-shadow: 0 0 20px #fff, 0 0 40px rgba(255,255,255,0.5);
            background: none;
            -webkit-text-fill-color: #fff;
        }
        #intro-screen p {
            font-size: 1.2rem; color: #aaa; animation: blink 1s infinite;
            margin-top: 50%;
            letter-spacing: 2px;
        }

        #menu-screen {
            background: none; 
            backdrop-filter: none;
            border: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 60px 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            pointer-events: none;
            transform: translateY(0);
            transition: opacity 0.3s, transform 0.3s;
        }

        #menu-screen h1 {
            font-size: 4rem;
            margin: 0;
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 5px;
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 10s ease infinite;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }
        
        .bottom-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            margin-bottom: 20px;
        }

        @keyframes rainbow { 
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        button {
            background: rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            padding: 15px 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin-bottom: 10px;
            pointer-events: auto;
        }

        button:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.3);
            border-color: #fff;
            text-shadow: 0 0 20px #fff;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .credit {
            font-size: 0.8rem;
            color: #fff;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            opacity: 0.8;
            pointer-events: auto;
        }

        .credit span {
            color: #fff;
            font-weight: bold;
        }
        
        #ranking-btn-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 50;
            pointer-events: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(0,0,0,0.5);
            transition: all 0.3s;
        }
        #ranking-btn-toggle:hover {
            color: #0ff;
            border-color: #0ff;
            text-shadow: 0 0 10px #0ff;
        }

        #ranking-board {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0ff;
            border-radius: 15px;
            padding: 20px;
            box-sizing: border-box;
            z-index: 60;
            pointer-events: auto;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
        }
        
        #high-score-list {
            list-style: none; padding: 0; margin: 15px 0 0 0; 
            font-size: 1rem; color: #fff; text-align: left;
            width: 100%; 
            /* 랭킹 목록이 길어지면 스크롤이 가능하도록 최대 높이를 설정합니다. */
            max-height: 400px; 
            overflow-y: auto;
        }
        
        #high-score-list li {
            padding: 10px 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        #high-score-list li:hover { background: rgba(0, 255, 255, 0.1); }
        
        #ranking-board h2 {
            color:#0ff; font-size:1.5rem; margin: 0 0 10px 0;
            font-weight: 700; text-shadow: 0 0 10px #0ff;
        }
        
        #close-ranking-board {
            margin-top: 15px;
            font-size: 1rem;
            padding: 5px 20px;
            border: 1px solid #555;
            color: #aaa;
            background: transparent;
        }
        #close-ranking-board:hover {
            color: #fff; border-color: #fff;
        }

        .replay-hint { font-size: 0.7rem; color: #aaa; margin-top: 5px; font-style: italic; }
        
        #initialsModal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); display: flex; justify-content: center; 
            align-items: center; z-index: 99; flex-direction: column;
            font-family: 'Orbitron', sans-serif; color: #fff;
            padding: 20px; box-sizing: border-box;
        }
        #initialsModal h2 { color:#f0f; text-shadow:0 0 10px #f0f; font-size: 2rem; margin-bottom: 10px; }
        #initialsModal input {
            padding: 10px; font-size: 1.5rem; text-align:center; border:3px solid #0ff; 
            background:#111122; color:#fff; width: 80%; max-width: 300px; text-transform:uppercase; 
            margin-top: 20px; border-radius: 8px;
        }
        #initialsModal button { margin-top:30px; font-size:1.5rem; padding:15px 40px; border: 2px solid #0ff; }
        #initialsModal button:disabled { border-color: #555; color: #555; cursor: not-allowed; }

        #close-replay-btn {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0000; border-radius: 50%;
            color: #fff; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; pointer-events: auto; transition: all 0.2s;
            animation: blink 1s infinite;
        }
        #close-replay-btn:hover { background: rgba(255, 0, 0, 0.5); transform: scale(1.1); }
        #replay-indicator {
            position: absolute; top: 20px; left: 20px; color: #0ff; font-size: 1rem;
            font-weight: bold; text-shadow: 0 0 10px #0ff; animation: blink 1s infinite; z-index: 20;
        }
        #loading-indicator {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            color: #FFFF00; font-size: 0.8rem; z-index: 100;
        }

        @keyframes blink { 50% { opacity: 0.5; } }

        .hide { opacity: 0; pointer-events: none !important; transform: translateY(20px) !important; }
        .display-none { display: none !important; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="intro-screen">
        <h1>TOP</h1>
        <p>CLICK TO START</p>
    </div>

    <div id="ui-layer">
        <div id="score-container">
            <div id="score">0</div>
        </div>
        <div id="combo-msg">PERFECT!</div>

        <div id="replay-indicator" class="display-none">REPLAY MODE</div>
        <div id="close-replay-btn" class="display-none">X</div>

        <div id="ranking-btn-toggle" class="display-none">RANKING</div>

        <div id="ranking-board">
            <h2>Worldwide Ranking</h2>
            <div class="replay-hint">Click initials to watch replay</div>
            <ul id="high-score-list">
                <li style="justify-content:center; color:#888;">Connecting...</li>
            </ul>
            <button id="close-ranking-board">CLOSE</button>
        </div>

        <div id="initialsModal" class="display-none"></div>

        <div id="menu-screen" class="hide">
            <h1>TOP</h1>
            
            <div class="bottom-controls">
                <button id="start-btn">PLAY</button>
                <div class="credit">Created by <span>GoldencatWinter</span></div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="loading-indicator" class="display-none">SYNCING...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- 1. [배포용] 본인의 FIREBASE 설정을 아래에 붙여넣으세요 ---
    // (이 설정은 깃허브 등에 배포했을 때 사용됩니다)
    const myFirebaseConfig = {
        apiKey: "AIzaSyCYEbWcIOd-h_pGylkwijzwsrlKnVjWKtA",
        authDomain: "top10-bab3c.firebaseapp.com",
        projectId: "top10-bab3c",
        storageBucket: "top10-bab3c.firebasestorage.app",
        messagingSenderId: "1058203815656",
        appId: "1:1058203815656:web:594790fd1a0d196ec6835d",
        measurementId: "G-S7EFBEHL7X"
    };

    // --- 2. [자동 감지] 실행 환경에 따라 설정을 자동으로 선택합니다 ---
    const isCanvasEnv = typeof __firebase_config !== 'undefined';
    let firebaseConfig;

    if (isCanvasEnv) {
        // [내부 테스트 환경] 자동으로 제공된 키 사용
        firebaseConfig = JSON.parse(__firebase_config);
        console.log("Running in Canvas Mode (Internal DB)");
    } else {
        // [외부 배포 환경] 위에서 입력한 myFirebaseConfig 사용
        firebaseConfig = myFirebaseConfig;
        console.log("Running in Export Mode (User DB)");
    }

    // --- Firebase Initialization ---
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase Init Error: 설정이 비어있거나 잘못되었습니다.");
    }
    
    let currentUser = null;
    const MAX_RANKING_COUNT = 30; // 랭킹 최대 표시 인원 설정

    // --- Helper: 실행 환경에 따라 올바른 DB 경로 가져오기 ---
    function getScoresCollection() {
        if (isCanvasEnv) {
            // [내부 규칙] artifacts/{appId}/public/data/scores
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return collection(db, 'artifacts', appId, 'public', 'data', 'scores');
        } else {
            // [외부 배포용] scores 컬렉션 (심플)
            return collection(db, 'scores');
        }
    }

    // --- Auth Logic ---
    async function initAuth() {
        if (!auth) return;
        try {
            if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            currentUser = auth.currentUser;
            refreshHighScores(); 
        } catch (error) {
            console.error("Auth failed:", error);
            ui.scoreList.innerHTML = '<li style="justify-content:center; color:#f00;">Connection Failed</li>';
        }
    }
    
    // --- DB Operations ---
    async function fetchTopScores() {
        if (!currentUser || !db) return [];
        try {
            const querySnapshot = await getDocs(getScoresCollection());
            let docs = [];
            querySnapshot.forEach((doc) => {
                docs.push({ id: doc.id, ...doc.data() });
            });
            docs.sort((a, b) => b.score - a.score);
            return docs; // 30개만 보여줄 것이므로, 모두 가져와서 정렬한 뒤에 잘라서 반환
        } catch (e) {
            console.error("Fetch error:", e);
            return [];
        }
    }

    // --- [수정] 30위 초과하는 항목을 삭제하도록 로직 변경 ---
    async function cleanupOldScores(allScores) {
        if (allScores.length > MAX_RANKING_COUNT) {
            // 상위 30개는 남기고, 그 이후 항목들을 삭제
            const toDelete = allScores.slice(MAX_RANKING_COUNT); 
            const deletePromises = toDelete.map(s => 
                deleteDoc(doc(getScoresCollection(), s.id))
            );
            await Promise.all(deletePromises);
            return allScores.slice(0, MAX_RANKING_COUNT);
        }
        return allScores;
    }

    async function addScoreToDB(score, initials, replayData) {
        if (!currentUser || !db) return;
        ui.loading.classList.remove('display-none');
        try {
            // 리플레이 데이터를 JSON 문자열로 저장하여 Firestore의 크기 제약 및 구조 문제를 회피
            await addDoc(getScoresCollection(), {
                score: score,
                initials: initials,
                replayData: JSON.stringify(replayData), // ReplayData를 JSON 문자열로 직렬화
                userId: currentUser.uid,
                timestamp: Date.now()
            });
            await refreshHighScores(); 
        } catch (e) {
            console.error("Save error:", e);
            // alert 대신 콘솔 로그 사용
            console.error("Save Failed. (If exported, check Firebase Rules and Replay Data Size)"); 
        } finally {
            ui.loading.classList.add('display-none');
        }
    }

    async function refreshHighScores() {
        // 모든 점수를 가져와서 정렬하고, 30위 초과하는 항목을 정리합니다.
        const allScores = await fetchTopScores();
        highScores = await cleanupOldScores(allScores);
        displayHighScores();
    }

    initAuth();


    /**
     * NEON STACK RHYTHM TOWER (DT Version 2.25x Speed)
     */

    const canvas = document.getElementById('gameCanvas');
    const wrapper = document.getElementById('game-wrapper');
    const ctx = canvas.getContext('2d', { alpha: false });
    const ui = {
        score: document.getElementById('score'),
        combo: document.getElementById('combo-msg'),
        menu: document.getElementById('menu-screen'),
        btn: document.getElementById('start-btn'),
        title: document.querySelector('#menu-screen h1'),
        credit: document.querySelector('.credit'),
        scoreList: document.getElementById('high-score-list'),
        rankingBtn: document.getElementById('ranking-btn-toggle'),
        rankingBoard: document.getElementById('ranking-board'),
        closeRankingBtn: document.getElementById('close-ranking-board'),
        closeReplayBtn: document.getElementById('close-replay-btn'),
        replayIndicator: document.getElementById('replay-indicator'),
        intro: document.getElementById('intro-screen'),
        loading: document.getElementById('loading-indicator')
    };

    // --- Delta Time Config (1.5x * 1.5x = 2.25x Faster) ---
    // All units converted to Per Second
    const CFG = {
        blockHeight: 40,
        baseWidth: 220,
        startSpeed: 675, // Was 450 -> 675 (2.25x original)
        speedInc: 11.25, // Was 7.5 -> 11.25
        perfectTol: 5,
        recoveryRate: 0.10, 
        shiningProb: 0.05,
        starCount: 600, 
        starSpeed: 67.5, // Was 45 -> 67.5
        gravity: 4050,   // Was 2700 -> 4050
        debrisRot: 22.5, // Was 15 -> 22.5
        particleDecay: 4.5 // Was 3.0 -> 4.5
    };

    let game = {
        state: 'intro', 
        blocks: [],
        debris: [],
        particles: [],
        stars: [],
        score: 0,
        combo: 0,
        cameraY: 0,
        baseHue: 0,
        current: { x: 0, y: 0, w: 0, h: 0, hue: 0, dir: 1, speed: 0, isShining: false },
        width: 0,
        height: 0,
        flashAlpha: 0,
        replayData: [],
        replayQueue: [],
        replayIndex: 0,
        currentSong: null 
    };
    let highScores = [];
    let lastTime = 0;

    const SONGS = [
        {
            title: "Gymnopédie No.1 - Erik Satie",
            notes: [369.99, 440.00, 392.00, 369.99, 277.18, 246.94, 277.18, 293.66, 369.99, 440.00, 392.00, 369.99, 277.18, 246.94, 220.00, 293.66]
        },
        {
            title: "Clair de Lune - Claude Debussy",
            notes: [349.23, 311.13, 277.18, 261.63, 233.08, 261.63, 233.08, 207.65, 277.18, 311.13, 349.23, 415.30, 369.99, 349.23, 311.13, 277.18]
        },
        {
            title: "Gnossienne No.1 - Erik Satie",
            notes: [369.99, 440.00, 392.00, 369.99, 440.00, 392.00, 369.99, 293.66, 369.99, 293.66, 246.94, 293.66, 369.99, 392.00, 369.99, 392.00]
        },
        {
            title: "Träumerei - Robert Schumann",
            notes: [261.63, 349.23, 329.63, 349.23, 440.00, 523.25, 349.23, 440.00, 392.00, 261.63, 466.16, 440.00, 392.00, 349.23, 329.63, 293.66]
        },
        {
            title: "Salut d'Amour - Edward Elgar",
            notes: [329.63, 415.30, 493.88, 329.63, 554.37, 493.88, 440.00, 415.30, 369.99, 329.63, 369.99, 440.00, 415.30, 493.88, 415.30, 369.99]
        },
        {
            title: "Air on the G String - J.S. Bach",
            notes: [369.99, 329.63, 293.66, 277.18, 246.94, 440.00, 392.00, 369.99, 329.63, 293.66, 329.63, 369.99, 440.00, 392.00, 369.99, 329.63]
        },
        {
            title: "Nocturne Op.9 No.2 - Frédéric Chopin",
            notes: [466.16, 392.00, 349.23, 392.00, 311.13, 392.00, 466.16, 392.00, 349.23, 311.13, 261.63, 311.13, 349.23, 392.00, 466.16, 523.25]
        },
        {
            title: "Moonlight Sonata - L.v. Beethoven",
            notes: [207.65, 277.18, 329.63, 207.65, 277.18, 329.63, 207.65, 277.18, 329.63, 207.65, 277.18, 329.63, 207.65, 277.18, 329.63, 207.65]
        },
        {
            title: "The Swan - Camille Saint-Saëns",
            notes: [392.00, 369.99, 493.88, 440.00, 293.66, 329.63, 369.99, 392.00, 369.99, 329.63, 293.66, 246.94, 293.66, 329.63, 369.99, 392.00]
        },
        {
            title: "Liebestraum No.3 - Franz Liszt",
            notes: [261.63, 311.13, 415.30, 523.25, 622.25, 523.25, 415.30, 311.13, 261.63, 311.13, 415.30, 523.25, 622.25, 523.25, 415.30, 311.13]
        }
    ];

    const AudioSys = {
        ctx: null,
        init() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.ctx.state === 'suspended') this.ctx.resume();
        },
        playOrgel(freq, vol = 0.3) {
            if (!this.ctx) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(freq, t);
            gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(vol, t + 0.01); 
            gain.gain.exponentialRampToValueAtTime(0.001, t + 1.8); 
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(t); osc.stop(t + 1.8);
            
            const osc2 = this.ctx.createOscillator(); const gain2 = this.ctx.createGain();
            osc2.type = 'sine'; osc2.frequency.setValueAtTime(freq * 2, t);
            gain2.gain.setValueAtTime(0, t); gain2.gain.linearRampToValueAtTime(vol * 0.15, t + 0.01);
            gain2.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
            osc2.connect(gain2); gain2.connect(this.ctx.destination);
            osc2.start(t); osc2.stop(t + 0.6);
        },
        playStack(combo) {
            if (!game.currentSong) return;
            const notes = game.currentSong.notes; const noteIdx = (game.score) % notes.length;
            let freq = notes[noteIdx];
            const cycleLen = 16; const maxOctave = 1; 
            const cycleStep = Math.floor(game.score / cycleLen);
            const cycleIndex = cycleStep % (maxOctave * 2);
            let octaveShift = cycleIndex;
            if (cycleIndex > maxOctave) octaveShift = (maxOctave * 2) - cycleIndex;
            freq = freq * 0.5 * Math.pow(2, octaveShift);
            this.playOrgel(freq, 0.4);
            if (combo > 0) { setTimeout(() => { this.playOrgel(freq * 1.5, 0.1); }, 120); }
        },
        playFail() {
            this.playOrgel(146.83, 0.5); setTimeout(() => this.playOrgel(130.81, 0.5), 200);
        }
    };
    
    function displayHighScores() {
        ui.scoreList.innerHTML = '';
        if (highScores.length === 0) {
            ui.scoreList.innerHTML = '<li style="color:#aaa; text-align:center;">No records yet.</li>';
            return;
        }
        // 랭킹은 cleanupOldScores에서 이미 MAX_RANKING_COUNT개로 정리되어 있으므로, 모두 표시합니다.
        highScores.forEach((score, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span style="color:#0ff; font-weight:bold; width:30px;">${index+1}.</span> 
                <span style="color:#fff; cursor:pointer; flex-grow:1; text-align:center;" title="Click to Watch Replay">
                    ${score.initials || 'TOP'} <span style="font-size:0.8em; color:#aaa; margin-left:5px;">▶</span>
                </span> 
                <span style="font-weight:bold; color:#f0f; width:60px; text-align:right;">${score.score}</span>
            `;
            li.querySelector('span:nth-child(2)').onclick = (e) => { 
                e.stopPropagation(); 
                if(score.replayData) {
                    try {
                        // DB에서 가져온 JSON 문자열을 다시 객체로 변환
                        const replayData = typeof score.replayData === 'string' ? JSON.parse(score.replayData) : score.replayData;
                        startReplay(replayData); 
                    } catch (error) {
                        console.error("Replay data parse error:", error);
                    }
                }
            };
            ui.scoreList.appendChild(li);
        });
    }

    function promptForInitials(newScore) {
        // 기존 modal이 있으면 제거
        const existingModal = document.getElementById('initialsModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'initialsModal';
        modal.innerHTML = `<h2>NEW WORLD RECORD!</h2><p>Score: ${newScore}<br>ENTER YOUR NAME</p><input type="text" id="initialsInput" maxlength="10"><button id="submitInitials">SAVE</button>`;
        wrapper.appendChild(modal); 
        const input = document.getElementById('initialsInput');
        const btn = document.getElementById('submitInitials');
        
        const submit = async () => {
            let val = input.value.toUpperCase().trim().replace(/[^A-Z0-9 ]/g,'') || "TOP";
            if(val.length > 10) val = val.slice(0, 10);
            
            btn.innerText = "SAVING...";
            btn.disabled = true;

            // 저장 시 리플레이 데이터는 game.replayData를 사용합니다.
            await addScoreToDB(newScore, val, game.replayData);
            
            modal.remove();
        };

        input.oninput = () => {
            input.value = input.value.toUpperCase().replace(/[^A-Z0-9 ]/g, '');
        };

        btn.onclick = submit;
        input.focus();
        input.onkeydown = (e) => { if(e.key==='Enter') submit(); };
    }

    // --- [수정] 반응형 로직 개선 (PC, 모바일 비율 유지) ---
    function resize() {
        const ASPECT_RATIO = 4 / 6; // 원하는 게임 화면 비율 (가로:세로)
        const parentW = window.innerWidth;
        const parentH = window.innerHeight;
        let w, h;

        if (parentW / parentH > ASPECT_RATIO) {
            // 현재 창의 가로가 더 길면 (데스크톱, 가로 모바일) -> 높이에 맞춰 너비 계산
            h = parentH;
            w = h * ASPECT_RATIO;
        } else {
            // 현재 창의 세로가 더 길면 (세로 모바일) -> 너비에 맞춰 높이 계산 (사용자가 요청한 방식)
            w = parentW;
            h = w / ASPECT_RATIO;
        }

        // 최대 크기를 넘지 않도록 제한
        const MAX_WIDTH = 600; 
        const MAX_HEIGHT = 900;
        if (w > MAX_WIDTH) {
            w = MAX_WIDTH;
            h = MAX_HEIGHT;
        }

        wrapper.style.width = `${w}px`; 
        wrapper.style.height = `${h}px`;
        game.width = w; 
        game.height = h; 
        canvas.width = w; 
        canvas.height = h;

        initStars();
    }
    
    function initStars() {
        game.stars = [];
        for (let i = 0; i < CFG.starCount; i++) {
            game.stars.push({
                x: Math.random() * game.width, y: Math.random() * game.height,
                size: Math.random() * 2 + 0.5, speed: Math.random() * CFG.starSpeed + 0.2,
                opacity: Math.random() * 0.5 + 0.3, twinkleSpeed: Math.random() * 0.05 + 0.01
            });
        }
    }
    window.addEventListener('resize', resize);
    resize();

    function initGame(isDemo = false) {
        game.state = isDemo ? 'demo' : 'playing';
        game.blocks = []; game.debris = []; game.particles = []; game.replayData = [];
        game.score = 0; game.combo = 0; game.cameraY = 0;
        game.baseHue = Math.floor(Math.random() * 360); game.flashAlpha = 0;
        
        if (!isDemo || !game.currentSong) { 
             // 노래가 없다면 랜덤으로 선택
             game.currentSong = SONGS[Math.floor(Math.random() * SONGS.length)]; 
        }

        ui.score.innerText = "0"; ui.score.classList.remove('score-pop'); 
        
        if (isDemo) {
            ui.menu.classList.remove('hide');
            ui.menu.classList.